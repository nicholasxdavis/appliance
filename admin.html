<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AJ's Repair - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Outfit', sans-serif; }
        .json-editor-input { @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500; }
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* BN Admin Popup Styles */
        :root {
            --bn-black: #000000;
            --bn-card-bg: #0a0a0a;
            --bn-white: #ffffff;
            --bn-orange: #ff6b00;
            --bn-grey: #888888;
            --bn-border-radius: 24px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999; /* Ensure high z-index */
            padding: 20px;
            animation: bnFadeIn 0.3s ease-out;
        }

        .bn-popup {
            position: relative;
            background: var(--bn-black);
            width: 100%;
            max-width: 420px;
            border-radius: var(--bn-border-radius);
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
            border: 1px solid #222;
            animation: bnSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .bn-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--bn-grey);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .bn-close-btn:hover {
            background: rgba(255,255,255,0.2);
            color: var(--bn-white);
            transform: rotate(90deg);
        }

        .bn-logo-container { margin-bottom: 25px; }
        .bn-logo-container a { display: inline-block; transition: opacity 0.2s; }
        .bn-logo-container a:hover { opacity: 0.8; }
        .bn-logo-container img { width: 140px; height: auto; display: block; margin: 0 auto; }

        .bn-h1 {
            color: var(--bn-white);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        }

        .bn-subtitle {
            color: var(--bn-orange);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 25px;
            display: block;
        }

        .bn-message-body {
            color: #ccc;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .bn-highlight-date {
            color: var(--bn-white);
            font-weight: 600;
            border-bottom: 1px solid var(--bn-orange);
        }

        .bn-lifetime-badge {
            display: inline-block;
            background: rgba(255, 107, 0, 0.15);
            color: var(--bn-orange);
            font-weight: 700;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 6px;
            margin: 0 2px;
            vertical-align: middle;
        }

        .bn-action-btn {
            background: var(--bn-white);
            color: var(--bn-black);
            border: none;
            padding: 12px 32px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            display: block;
        }

        .bn-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 255, 255, 0.1);
        }

        .bn-contact-btn {
            background: transparent;
            color: var(--bn-grey);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px 32px;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 12px;
            display: block;
            text-decoration: none;
            text-align: center;
        }

        .bn-contact-btn:hover {
            border-color: var(--bn-white);
            color: var(--bn-white);
            background: rgba(255, 255, 255, 0.05);
        }

        @keyframes bnFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bnSlideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 z-20 flex-shrink-0">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-14">
                <div class="flex items-center gap-4 flex-shrink-0">
                    <span class="text-xl font-bold text-gray-800">Admin <span class="hidden sm:inline">Panel</span></span>
                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full hidden" id="connection-status">Connected</span>
                </div>
                <!-- Right Side Controls -->
                <div class="flex items-center gap-2 sm:gap-4 overflow-x-auto no-scrollbar ml-4">
                    <input type="file" id="backup-input" accept=".json" class="hidden" onchange="importBackup(this)">
                    
                    <button onclick="document.getElementById('backup-input').click()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm flex items-center gap-2 text-white whitespace-nowrap">
                        <i class="fa-solid fa-file-import"></i> <span class="hidden sm:inline">Restore</span>
                    </button>
                    <button onclick="downloadBackup()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm flex items-center gap-2 text-white whitespace-nowrap">
                        <i class="fa-solid fa-download"></i> <span class="hidden sm:inline">Backup</span>
                    </button>
                    
                    <div class="h-6 w-px bg-gray-600 mx-1 sm:mx-2"></div>
                    
                    <button id="save-btn" onclick="saveContent()" class="hidden bg-green-600 hover:bg-green-500 px-4 py-1.5 sm:px-6 sm:py-2 rounded font-bold transition flex items-center gap-2 shadow-lg hover:shadow-green-500/20 text-white whitespace-nowrap text-xs sm:text-base">
                        <i class="fa-solid fa-cloud-upload"></i> Save
                    </button>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 text-sm px-2">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Editor Sidebar (Left) -->
        <div id="editor-pane" class="w-full md:w-1/3 bg-white border-r border-gray-200 flex flex-col overflow-hidden hidden relative order-2 md:order-1 h-1/2 md:h-auto">
             <div class="border-b border-gray-200 bg-gray-50 overflow-x-auto flex-shrink-0">
                <div id="section-tabs" class="flex"></div>
            </div>
            <div id="editor-container" class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Fields injected here -->
            </div>
        </div>

        <!-- Preview Pane (Right) -->
        <div id="preview-pane" class="w-full md:w-2/3 bg-gray-100 relative hidden flex-col order-1 md:order-2 h-1/2 md:h-auto border-b md:border-b-0 md:border-l border-gray-300">
            <div class="bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center text-xs text-gray-500 flex-shrink-0">
                <span class="font-bold uppercase tracking-wider"><i class="fa-solid fa-eye"></i> Live Preview</span>
                <button onclick="document.getElementById('preview-frame').contentWindow.location.reload()" class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded transition flex items-center gap-1">
                    <i class="fa-solid fa-rotate-right"></i> Refresh
                </button>
            </div>
            <iframe id="preview-frame" src="index.html" class="w-full h-full border-none bg-white"></iframe>
        </div>

        <!-- Auth Overlay (GitHub) -->
        <div id="auth-section" class="absolute inset-0 bg-gray-100 z-40 flex items-center justify-center hidden">
            <!-- (Content remains same but initially hidden) -->
             <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full relative">
                <button onclick="logoutApp()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <h2 class="text-2xl font-bold mb-2 text-center text-gray-800">GitHub Connection</h2>
                <!-- ... form ... -->
                <form onsubmit="event.preventDefault(); login();" class="space-y-4 mt-6">
                    <!-- ... inputs ... -->
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Owner / Username</label>
                        <input type="text" id="repo-owner" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" value="nicholasxdavis" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Repository</label>
                        <input type="text" id="repo-name" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" value="appliance" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">
                            GitHub Token <span class="text-gray-400 font-normal">(Value of GITHUB0API0KEY)</span>
                        </label>
                        <input type="password" id="github-token" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Paste your GITHUB0API0KEY here" required>
                        <p class="text-xs text-gray-400 mt-1">
                            <i class="fa-solid fa-circle-info"></i> Browser cannot fetch Secrets automatically. Please paste the token value.
                        </p>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2.5 rounded-md hover:bg-blue-700 transition font-medium shadow-sm">Connect Dashboard</button>
                    <p id="login-error" class="hidden text-red-500 text-xs text-center mt-2"></p>
                </form>
            </div>
        </div>

        <!-- App Login Overlay (Gatekeeper) -->
        <div id="app-login-section" class="absolute inset-0 bg-gray-900 z-50 flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Admin Access</h1>
                    <p class="text-sm text-gray-500">Please authenticate to continue</p>
                </div>
                
                <form onsubmit="event.preventDefault(); appLogin();" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Email</label>
                        <input type="email" id="app-email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Password</label>
                        <input type="password" id="app-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                    </div>
                    <button type="submit" class="w-full bg-gray-800 text-white py-2.5 rounded-md hover:bg-gray-900 transition font-medium shadow-sm">
                        Login
                    </button>
                    <p id="app-login-error" class="hidden text-center text-red-600 text-xs font-medium"></p>
                </form>
            </div>
        </div>

    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toast-msg">Notification</span>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 sm:p-0" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="float-right sticky top-4 text-gray-400 hover:text-gray-600 z-10 bg-white rounded-full p-1 shadow-sm border border-gray-100">
                <i class="fa-solid fa-xmark fa-lg"></i>
            </button>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Section Help</h3>
            <div id="help-content" class="space-y-4">
                <!-- Help content will be injected here -->
            </div>
        </div>
    </div>

    <!-- BN POPUP COMPONENT -->
    <div id="bnModal" class="modal-overlay hidden">
        <div class="bn-popup">
            <!-- Close Icon Top Right -->
            <button class="bn-close-btn" onclick="closeBnPopup()" aria-label="Close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <!-- Centered Logo -->
            <div class="bn-logo-container">
                <a href="https://www.blacnova.net" target="_blank" rel="noopener noreferrer">
                    <img src="https://www.blacnova.net/img/logo_white.png" alt="Blacnova Logo">
                </a>
            </div>

            <!-- Content -->
            <h1 class="bn-h1">Welcome AJ's Appliance</h1>
            <span class="bn-subtitle">To Your Admin Panel</span>

            <p class="bn-message-body">
                Thank you for being a valued client since <span class="bn-highlight-date">1/31/2026</span>.
                <br><br>
                You have been gifted <span class="bn-lifetime-badge">LIFETIME ACCESS</span> to Blacnova Development hosting services and CMS fees with included admin panel.
            </p>

            <button class="bn-action-btn" onclick="closeBnPopup()">
                Access Panel
            </button>
            
            <a href="https://www.blacnova.net/#contact" target="_blank" rel="noopener noreferrer" class="bn-contact-btn">
                Contact Support
            </a>
        </div>
    </div>

    <script>
        // Popup Control Logic
        function checkWelcomePopup() {
            const hasSeenPopup = localStorage.getItem('bn_admin_popup_seen');
            if (!hasSeenPopup) {
                const modal = document.getElementById('bnModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    // Ensure it's on top of everything
                    modal.style.zIndex = '9999';
                }
            }
        }

        function closeBnPopup() {
            document.getElementById('bnModal').classList.add('hidden');
            localStorage.setItem('bn_admin_popup_seen', 'true');
        }
    </script>

    <!-- Load Config (Injected Secrets) -->
    <script src="js/config.js"></script> <!-- Will fail silently if not present, which is fine -->

    <script>
        // State
        let currentContent = null;
        let fileSha = null;
        let activeTab = 'general';
        const previewFrame = document.getElementById('preview-frame');

        // SECTION INFO & PREVIEWS
        const SECTION_INFO = {
            'inbox': { title: 'Message Inbox', desc: 'Private messages from your Contact/Quote forms.', html: '<div class="p-2 bg-yellow-50 border border-yellow-200 rounded"><div class="text-[8px] font-bold">New Message</div><div class="text-[6px]">From: John Doe</div></div>' },
            'general': {
                title: 'General Settings',
                desc: 'Controls global settings like the website title, description (for SEO), and main contact info.',
                html: '<div class="p-4 border border-blue-200 rounded bg-blue-50 text-center"><h3 class="font-bold text-lg">Website Title</h3><p class="text-xs text-gray-500">Meta Description for Google...</p></div>'
            },
            'hero': {
                title: 'Hero / Banner',
                desc: 'The top-most section of your home page. This is the first thing visitors see.',
                html: '<div class="h-32 bg-gray-800 text-white flex flex-col items-center justify-center rounded"><h1 class="text-xl font-bold">Main Title</h1><button class="mt-2 bg-yellow-500 text-xs px-2 py-1 rounded">Call to Action</button></div>'
            },
            'trust': {
                title: 'Trust Indicators',
                desc: 'Logos of organizations you are affiliated with (e.g., Angi, BBB) to build credibility.',
                html: '<div class="h-16 bg-gray-100 flex items-center justify-center gap-4 rounded border border-gray-200"><div class="w-8 h-8 bg-gray-300 rounded-full"></div><div class="w-8 h-8 bg-gray-300 rounded-full"></div><div class="w-8 h-8 bg-gray-300 rounded-full"></div></div>'
            },
            'brands': {
                title: 'Brands We Servic',
                desc: 'A scrolling list of appliance brands you repair.',
                html: '<div class="h-20 border border-dashed border-gray-300 rounded flex items-center justify-around overflow-hidden"><span class="text-xs text-gray-400">Samsung</span><span class="text-xs text-gray-400">LG</span><span class="text-xs text-gray-400">Whirlpool</span></div>'
            },
            'services': {
                title: 'Our Services',
                desc: 'The core services you offer. Each item has an icon, title, and description.',
                html: '<div class="grid grid-cols-2 gap-2"><div class="p-2 border rounded bg-white"><div class="w-4 h-4 bg-blue-100 mb-1"></div><div class="h-2 w-12 bg-gray-200 mb-1"></div><div class="h-8 w-full bg-gray-50"></div></div><div class="p-2 border rounded bg-white"><div class="w-4 h-4 bg-blue-100 mb-1"></div><div class="h-2 w-12 bg-gray-200 mb-1"></div><div class="h-8 w-full bg-gray-50"></div></div></div>'
            },
            'about': {
                title: 'About Us',
                desc: 'Your company story, image, and key stats.',
                html: '<div class="flex gap-2"><div class="w-1/3 bg-gray-200 h-24 rounded"></div><div class="flex-1 space-y-2"><div class="h-4 w-3/4 bg-gray-200"></div><div class="h-12 w-full bg-gray-50 text-[6px] p-1">Your story goes here...</div></div></div>'
            },
             'serviceArea': {
                title: 'Service Area',
                desc: 'Map and list of cities you serve.',
                html: '<div class="flex gap-2"><div class="w-1/2 bg-green-50 border border-green-100 h-24 rounded flex items-center justify-center text-xs text-green-700">Map Image</div><ul class="w-1/2 text-[8px] space-y-1"><li class="flex gap-1"><span class="w-1 h-1 bg-green-500 rounded-full"></span> Las Cruces</li><li class="flex gap-1"><span class="w-1 h-1 bg-green-500 rounded-full"></span> Mesilla</li></ul></div>'
            },
            'reviews': {
                title: 'Customer Reviews',
                desc: 'Testimonials from your happy customers.',
                html: '<div class="p-2 border-l-4 border-yellow-400 bg-gray-50 rounded-r"><div class="flex text-yellow-400 text-[8px] gap-0.5 mb-1"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div><p class="text-[8px] text-gray-600">"Great service!" - Bob</p></div>'
            },
             'gallery': {
                title: 'Photo Gallery',
                desc: 'A collage of photos showing your recent work.',
                html: '<div class="grid grid-cols-3 gap-1 h-24"><div class="bg-gray-300 col-span-2 row-span-2 rounded"></div><div class="bg-gray-200 rounded"></div><div class="bg-gray-200 rounded"></div></div>'
            },
             'blog': {
                title: 'Blog / News',
                desc: 'Articles and updates. Good for SEO and keeping customers informed.',
                html: '<div class="grid grid-cols-2 gap-2"><div class="border rounded p-2"><div class="h-12 bg-gray-200 mb-2 rounded"></div><div class="h-2 w-16 bg-gray-300 mb-1"></div><div class="h-2 w-10 bg-gray-200"></div></div><div class="border rounded p-2"><div class="h-12 bg-gray-200 mb-2 rounded"></div><div class="h-2 w-16 bg-gray-300 mb-1"></div><div class="h-2 w-10 bg-gray-200"></div></div></div>'
            },
            'quote': {
                title: 'Get a Quote',
                desc: 'The bottom section containing the contact form/footer.',
                html: '<div class="bg-gray-800 h-24 text-white flex items-center justify-center"><div class="text-center"><div class="text-[8px] uppercase">Contact Us</div><div class="text-xs font-bold">555-0123</div></div></div>'
            },
             'nav': { title: 'Navigation', desc: 'Links in the top header.', html: '' },
             'footer': { title: 'Footer', desc: 'Bottom copyright text.', html: '' },
             'maintenance': { title: 'Maintenance Mode', desc: 'Lock the site with an overlay message.', html: '<div class="h-24 bg-gray-900 flex items-center justify-center text-white"><i class="fa-solid fa-lock mr-2"></i> Under Maintenance</div>' }
        };

        // Credentials Configuration
        const VALID_USERS = [];

        // Load credentials on start
        document.addEventListener('DOMContentLoaded', () => {
             // 1. Consume Injected Config
             if (window.CONFIG) {
                 // Fix: detailed check for VALID_USERS property
                 const users = window.CONFIG.VALID_USERS || window.CONFIG.auth;
                 if (users && Array.isArray(users)) {
                     users.forEach(u => {
                         if(u.email && u.pass) VALID_USERS.push(u);
                     });
                 }
                 
                 // Auto-fill GitHub Token if available
                 if (window.CONFIG.GITHUB_TOKEN && !localStorage.getItem('gh_token')) {
                     document.getElementById('github-token').value = window.CONFIG.GITHUB_TOKEN;
                 }
             } else {
                 // Config missing detector
                 console.warn('js/config.js not loaded. Secrets will not be available.');
                 const authSection = document.getElementById('auth-section');
                 if(authSection) {
                     const warning = document.createElement('div');
                     warning.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 text-sm';
                     warning.innerHTML = `
                        <p class="font-bold">⚠️ Secrets Configuration Missing</p>
                        <p>The file <code>js/config.js</code> returned 404.</p>
                        <p class="mt-2"><strong>Fix:</strong> Go to Repo Settings > Pages > Build and deployment.</p>
                        <p>Change <strong>Source</strong> to "GitHub Actions".</p>
                     `;
                     // Insert at top of auth/login forms
                     const appLogin = document.getElementById('app-login-section');
                     if(appLogin && !appLogin.classList.contains('hidden')) {
                         appLogin.querySelector('form').before(warning.cloneNode(true));
                     }
                     authSection.querySelector('form').before(warning);
                 }
             }

             // Add hardcoded fallback for manual testing/demo if config is empty
             if (VALID_USERS.length === 0) {
                 VALID_USERS.push({ email: 'nic@example.com', pass: 'passwordexample' });
                 VALID_USERS.push({ email: 'admin@example.com', pass: 'password' });
                 // Fallback only; if user runs inject_config.js with valid envs, they get priority.
             }

             // Check App Auth
             if (sessionStorage.getItem('app_authenticated') === 'true') {
                 showGitHubAuth();
             }
        });

        function appLogin() {
            const email = document.getElementById('app-email').value;
            const pass = document.getElementById('app-password').value;
            const errorMsg = document.getElementById('app-login-error');

            const isValid = VALID_USERS.some(u => u.email === email && u.pass === pass);

            if (isValid) {
                sessionStorage.setItem('app_authenticated', 'true');
                showGitHubAuth();
            } else {
                errorMsg.textContent = 'Invalid Credentials. Access Denied.';
                errorMsg.classList.remove('hidden');
            }
        }

        function logoutApp() {
            sessionStorage.removeItem('app_authenticated');
            location.reload();
        }

        function showGitHubAuth() {
            document.getElementById('app-login-section').classList.add('hidden');
            
            // 1. Try LocalStorage (Existing session) or Injected Config (Auto-login)
            const token = localStorage.getItem('gh_token') || (window.CONFIG && window.CONFIG.GITHUB_TOKEN);
            
            // Allow override of owner/repo if injected via config (not currently set but future proof)
            const owner = localStorage.getItem('gh_owner') || 'nicholasxdavis';
            const repo = localStorage.getItem('gh_repo') || 'appliance';

            if (token) {
                // Pre-fill inputs just in case, but hide section ideally
                document.getElementById('github-token').value = token;
                document.getElementById('repo-owner').value = owner;
                document.getElementById('repo-name').value = repo; 
                
                attemptLogin(token, owner, repo);
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
            }
        }

        function login() {
            const token = document.getElementById('github-token').value;
            const owner = document.getElementById('repo-owner').value;
            const repo = document.getElementById('repo-name').value;
            attemptLogin(token, owner, repo);
        }

        async function attemptLogin(token, owner, repo) {
            const btn = document.querySelector('button[type="submit"]');
            if(btn) { btn.disabled = true; btn.textContent = 'Connecting...'; }

            try {
                // Test connection by fetching user
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (!userRes.ok) throw new Error('Invalid Token');

                localStorage.setItem('gh_token', token);
                localStorage.setItem('gh_owner', owner);
                localStorage.setItem('gh_repo', repo);

                await loadContent();
                
                // Show UI
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('editor-pane').classList.remove('hidden');
                document.getElementById('preview-pane').classList.remove('hidden');
                document.getElementById('preview-pane').classList.add('flex');
                document.getElementById('save-btn').classList.remove('hidden');
                document.getElementById('connection-status').classList.remove('hidden');

                // Trigger Welcome Popup if applicable
                checkWelcomePopup();

            } catch (error) {
                console.error(error);
                document.getElementById('login-error').textContent = error.message;
                document.getElementById('login-error').classList.remove('hidden');
                // Show auth section so user can see error and retry manually if needed
                document.getElementById('auth-section').classList.remove('hidden'); 
                localStorage.removeItem('gh_token'); 
            } finally {
                if(btn) { btn.disabled = false; btn.textContent = 'Connect Dashboard'; }
            }
        }

        function logout() {
            localStorage.removeItem('gh_token');
            location.reload();
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${isError ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        async function loadContent() {
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const path = 'content.json';

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                });

                if (!response.ok) throw new Error('Could not fetch content.json');

                const data = await response.json();
                fileSha = data.sha;
                
                // Decode UTF-8 properly
                const decodedContent = decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, ""))));
                currentContent = JSON.parse(decodedContent);

                renderTabs();
                renderTabs();
                // Fix: Pass the actual content object, not just the string key
                if (currentContent[activeTab]) {
                    renderEditor(currentContent[activeTab], [activeTab]);
                } else {
                    renderEditor({}, [activeTab]);
                }
                updatePreview(); // Initial sync
                updatePreview(); // Initial sync

            } catch (error) {
                console.error(error);
                showToast(error.message, true);
            }
        }

        // Debounce timer
        let previewTimeout;

        function updatePreview() {
            if (!currentContent) return;
            
            // Clear existing timeout
            if (previewTimeout) clearTimeout(previewTimeout);

            // Debounce for 50ms to strictly follow 'live' feel without choking
            previewTimeout = setTimeout(() => {
                console.log('Sending preview update...', new Date().toISOString());
                const previewFrame = document.getElementById('preview-frame');
                if (previewFrame && previewFrame.contentWindow) {
                    previewFrame.contentWindow.postMessage({
                        type: 'previewUpdate',
                        content: currentContent
                    }, '*');
                }
            }, 50);
        }

        // Add listener to iframe load to ensure we sync on initial load
        const previewFrameEl = document.getElementById('preview-frame');
        if (previewFrameEl) {
             // Cache buster
             previewFrameEl.src = `index.html?t=${Date.now()}`;
             
             previewFrameEl.onload = () => {
                 setTimeout(updatePreview, 500);
             };
        }

        // Backup & Restore
        function downloadBackup() {
            if (!currentContent) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentContent, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "cms_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importBackup(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    // Basic validation
                    if (!json.general || !json.hero) {
                        alert("Invalid backup file. Missing core sections.");
                        return;
                    }
                    
                    if (confirm("This will replace all current content in the editor with the backup. Proceed?")) {
                        currentContent = json;
                        renderEditor(currentContent);
                        updatePreview();
                        alert("Backup loaded! Click 'Save Changes' to push to GitHub.");
                    }
                } catch (err) {
                    alert("Error parsing JSON: " + err.message);
                }
                inputElement.value = ''; // Reset
            };
            reader.readAsText(file);
        }

        async function saveContent() {
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const path = 'content.json';
            
            const btn = document.getElementById('save-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="loader"></i> Saving...';
            btn.disabled = true;

            try {
                const contentStr = JSON.stringify(currentContent, null, 2);
                const encodedContent = window.btoa(unescape(encodeURIComponent(contentStr)));

                const body = {
                    message: "Update content via Admin Panel",
                    content: encodedContent,
                    sha: fileSha
                };

                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error('Failed to save to GitHub');

                const data = await response.json();
                fileSha = data.content.sha;
                showToast('Changes saved successfully!');
            } catch (error) {
                console.error(error);
                showToast('Error saving: ' + error.message, true);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // Image Upload Logic
        async function uploadImage(file, fieldPath) {
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            
            if (!file) return;

            showToast('Uploading image...');

            try {
                // Read file as Base64
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const contentBase64 = e.target.result.split(',')[1];
                    const filename = `img/${Date.now()}_${file.name.replace(/\s+/g, '-')}`; // Unique name
                    
                    // Upload to GitHub
                    const body = {
                        message: `Upload image ${file.name}`,
                        content: contentBase64
                    };

                    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filename}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) throw new Error('Image upload failed');
                    
                    const data = await response.json();
                    
                    // Get 'download_url' or construct relative path if using Pages
                    // Using relative path is safer for this specific setup
                    const imagePath = filename; 
                    
                    // Update Content
                    updateContentInState(fieldPath, imagePath);
                    
                    // Force refresh editor input
                    renderEditor(activeTab); // Brute force refresh to show new value
                    showToast('Image uploaded and linked!');
                };
                reader.readAsDataURL(file);

            } catch (error) {
                console.error(error);
                showToast('Upload error: ' + error.message, true);
            }
        }


        // UI Rendering Logic ----------------------



        function renderTabs() {
            const container = document.getElementById('section-tabs');
            container.innerHTML = '';
            
            Object.keys(currentContent).forEach(key => {
                const tab = document.createElement('button');
                tab.className = `px-6 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition ${activeTab === key ? 'border-brand text-brand bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`;
                tab.textContent = SECTION_INFO[key] ? SECTION_INFO[key].title : key;
                tab.onclick = () => {
                    activeTab = key;
                    renderTabs();
                    if (key === 'inbox') loadInbox(); 
                    else renderEditor(currentContent[key], [key]);
                };
                container.appendChild(tab);
            });
            
            // Add Inbox Tab manually
            const inboxTab = document.createElement('button');
            inboxTab.className = `px-6 py-3 text-sm font-medium whitespace-nowrap border-b-2 transition ${activeTab === 'inbox' ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'}`;
            inboxTab.innerHTML = '<i class="fa-solid fa-inbox mr-2"></i>Inbox';
            inboxTab.onclick = () => {
                activeTab = 'inbox';
                renderTabs();
                loadInbox();
            };
            container.appendChild(inboxTab);
        }

        async function loadInbox() {
            const container = document.getElementById('editor-container');
            container.innerHTML = '<div class="text-center py-10 text-gray-500"><i class="loader"></i> Loading Inbox...</div>';
            
            // Use Private Key if available, otherwise fallback (will likely fail for private repo if not authenticated)
            const token = (window.CONFIG && window.CONFIG.PRIVATE_KEY) ? window.CONFIG.PRIVATE_KEY : localStorage.getItem('gh_token');
            const owner = 'nicholasxdavis'; 
            const repo = 'private'; // Hardcoded private repo
            
            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/inbox.json`, {
                    headers: { 
                        'Authorization': `token ${token}`, 
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        renderInbox([], null); // No inbox file yet
                        return;
                    }
                    throw new Error('Failed to load inbox (Check PRIVATE0API0KEY)');
                }

                const data = await response.json();
                // Decode assuming base64
                const contentStr = decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, ""))));
                const messages = JSON.parse(contentStr);
                renderInbox(messages, data.sha);

            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded text-center">Error: ${error.message}</div>`;
            }
        }

        function renderInbox(messages, sha) {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-6 pb-4 border-b border-gray-100';
            header.innerHTML = `<h2 class="text-xl font-bold text-gray-800">Inbox</h2> <span class="text-xs text-gray-400 font-mono">${messages.length} messages</span>`;
            container.appendChild(header);

            if (!messages || messages.length === 0) {
                container.innerHTML += '<div class="text-center text-gray-400 py-12 flex flex-col items-center gap-2"><i class="fa-regular fa-envelope-open fa-2x"></i><span>Inbox is empty</span></div>';
                return;
            }

            const list = document.createElement('div');
            list.className = 'space-y-4';
            
            messages.forEach((msg, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg p-5 hover:shadow-md transition group relative';
                
                const date = new Date(msg.date).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                             <div class="w-2 h-2 rounded-full ${msg.type === 'Quote' ? 'bg-purple-500' : 'bg-blue-500'}"></div>
                             <h3 class="font-bold text-gray-800">${msg.name || 'Unknown'}</h3>
                             <span class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded">${msg.type || 'Contact'}</span>
                        </div>
                        <div class="flex items-center gap-3">
                             <span class="text-xs text-gray-400">${date}</span>
                             <button onclick="deleteMessage('${sha}', ${index})" class="text-gray-300 hover:text-red-500 transition" title="Delete Message"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 mb-3 flex flex-wrap gap-4 border-b border-gray-50 pb-3">
                        <a href="mailto:${msg.email}" class="flex items-center gap-1 hover:text-blue-600 transition"><i class="fa-regular fa-envelope text-xs"></i> ${msg.email}</a>
                        ${msg.phone ? `<a href="tel:${msg.phone}" class="flex items-center gap-1 hover:text-blue-600 transition"><i class="fa-solid fa-phone text-xs"></i> ${msg.phone}</a>` : ''}
                        ${msg.service ? `<span class="flex items-center gap-1 text-purple-600 bg-purple-50 px-2 py-0.5 rounded text-xs font-medium"><i class="fa-solid fa-screwdriver-wrench"></i> ${msg.service}</span>` : ''}
                    </div>
                    
                    <div class="prose prose-sm max-w-none text-gray-700">
                        <p class="whitespace-pre-wrap font-light italic">"${msg.message}"</p>
                    </div>
                `;
                list.appendChild(card);
            });
            
            container.appendChild(list);
        }

        async function deleteMessage(sha, index) {
            if(!confirm('Are you sure you want to delete this message? This cannot be undone.')) return;
            
            const token = (window.CONFIG && window.CONFIG.PRIVATE_KEY) ? window.CONFIG.PRIVATE_KEY : localStorage.getItem('gh_token');
            const owner = 'nicholasxdavis';
            const repo = 'private';
            const path = 'inbox.json';

            // Show global loading or toast
            showToast('Deleting message...');
            
            try {
                // 1. Fetch latest to ensure no conflicts (optimistic locking)
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                     headers: { 'Authorization': `token ${token}` }
                });
                const data = await res.json();
                const content = JSON.parse(decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, "")))));
                
                // 2. Remove item
                content.splice(index, 1);
                
                // 3. Save back
                const newContent = window.btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));
                
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Delete inbox message",
                        content: newContent,
                        sha: data.sha
                    })
                });
                
                showToast('Message deleted');
                loadInbox(); // Reload UI
                
            } catch(e) {
                console.error(e);
                alert('Failed to delete: ' + e.message);
            }
        }

        function renderEditor(data, path = []) {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';

            // Show Section Header with Help Button
            if (path.length > 0 && path.length <= 1) { // Root of a section
                const sectionKey = path[0];
                const info = SECTION_INFO[sectionKey];
                
                if (info) {
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center mb-6 pb-4 border-b border-gray-100';
                    
                    const title = document.createElement('h2');
                    title.className = 'text-xl font-bold text-gray-800 capitalize';
                    title.textContent = info.title;
                    
                    const helpBtn = document.createElement('button');
                    helpBtn.className = 'text-blue-500 hover:text-blue-700 hover:bg-blue-50 px-3 py-1.5 rounded-full text-xs font-medium transition flex items-center gap-2 border border-blue-200';
                    helpBtn.innerHTML = '<i class="fa-solid fa-circle-question"></i> What is this?';
                    helpBtn.onclick = () => showHelp(sectionKey);
                    
                    header.appendChild(title);
                    header.appendChild(helpBtn);
                    container.appendChild(header);
                }
            }

            if (Array.isArray(data)) {
                // Primitive arrays check inside createArrayEditor
                createArrayEditor(container, data, path);
                return;
            }

            createFields(container, data, path);
        }

        function createFields(container, data, path) {
            if (typeof data !== 'object' || data === null) {
                // Check if it's an image field (heuristic: key contains 'img' or 'image' or 'logo')
                let isImage = false;
                if (path.length > 0) {
                    const key = path[path.length - 1].toLowerCase();
                    // Fix: Use more robust check for image keys, including nested 'images' object keys
                    isImage = key.includes('img') || key.includes('image') || key.includes('logo') || key.includes('icon') || path.includes('images');
                }
                
                createInput(container, data, path, isImage);
                return;
            }

            if (Array.isArray(data)) {
                createArrayEditor(container, data, path);
                return;
            }

            Object.keys(data).forEach(key => {
                const val = data[key];
                if (typeof val !== 'object') {
                    const isImage = key.toLowerCase().includes('img') || key.toLowerCase().includes('image') || key.toLowerCase().includes('logo') || key.toLowerCase().includes('icon');
                    createInput(container, val, [...path, key], isImage);
                } else {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'mb-6 border-l-2 border-gray-100 pl-4 py-1';
                    const title = document.createElement('h3');
                    title.className = 'text-xs font-bold text-gray-400 uppercase tracking-wider mb-3';
                    title.textContent = key;
                    wrapper.appendChild(title);
                    createFields(wrapper, val, [...path, key]);
                    container.appendChild(wrapper);
                }
            });
        }

        function createInput(container, value, path, isImage = false) {
            let input; // Fix: Declare variable before usage
            const wrapper = document.createElement('div');
            wrapper.className = 'mb-4 group';

            const labelRow = document.createElement('div');
            labelRow.className = 'flex justify-between items-center mb-1';
            
            const fieldLabel = document.createElement('label');
            fieldLabel.className = 'text-sm font-medium text-gray-700 capitalize';
            fieldLabel.textContent = path[path.length - 1];
            labelRow.appendChild(fieldLabel);

            wrapper.appendChild(labelRow);

            if (typeof value === 'boolean') {
                input = document.createElement('input');
                input.type = 'checkbox';
                input.checked = value;
                input.className = 'w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300 transition cursor-pointer';
                input.onchange = (e) => {
                    updateContentInState(path, e.target.checked);
                };
                
                // Special styling for boolean wrapper
                wrapper.className = 'mb-4 flex items-center gap-3 bg-gray-50 p-3 rounded-md border border-gray-200';
                labelRow.className = 'flex-1 mb-0';
                wrapper.innerHTML = ''; // Reset wrapper
                
                wrapper.appendChild(input);
                
                const label = document.createElement('label');
                label.className = 'text-sm font-medium text-gray-700 capitalize cursor-pointer select-none';
                label.textContent = path[path.length - 1];
                label.onclick = () => { input.click(); }; // Make label clickable
                wrapper.appendChild(label);
                
                container.appendChild(wrapper);
                return; // Early return for boolean
            }

            if (typeof value === 'string' && value.length > 60 && !isImage) {
                input = document.createElement('textarea');
                input.rows = 3;
            } else {
                input = document.createElement('input');
                input.type = 'text';
            }
            
            // Special handling for Action URL
            if (path[path.length-1] === 'actionUrl' && window.CONFIG && window.CONFIG.SCRIPT_URL) {
                 input.value = window.CONFIG.SCRIPT_URL; 
                 input.readOnly = true;
                 input.className = 'w-full px-3 py-2 bg-gray-100 text-gray-500 border border-gray-200 rounded text-sm cursor-not-allowed';
                 input.title = "Managed via GitHub Secrets (SCRIPT0URL)";
                 
                 const badge = document.createElement('span');
                 badge.className = 'text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded ml-2 uppercase tracking-wide border border-blue-200';
                 badge.innerHTML = '<i class="fa-solid fa-server"></i> Managed by Secrets';
                 labelRow.appendChild(badge);
            } else {
                 input.className = 'w-full px-3 py-2 bg-white border border-gray-200 rounded text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition shadow-sm font-light text-gray-800';
                 input.value = value;
            }
            
            input.oninput = (e) => {
                updateContentInState(path, e.target.value);
            };

            wrapper.appendChild(input);

            // Image Upload Control
            if (isImage) {
                const uploadContainer = document.createElement('div');
                uploadContainer.className = 'mt-2 flex items-center gap-2';
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.className = 'hidden';
                fileInput.id = `file-${path.join('-')}`;
                
                fileInput.onchange = (e) => {
                    if (e.target.files.length > 0) {
                        uploadImage(e.target.files[0], path);
                    }
                };

                const uploadBtn = document.createElement('label');
                uploadBtn.htmlFor = fileInput.id;
                uploadBtn.className = 'cursor-pointer inline-flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded hover:bg-gray-200 transition';
                uploadBtn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> Upload New Image';
                
                uploadContainer.appendChild(fileInput);
                uploadContainer.appendChild(uploadBtn);
                
                // Thumbnail preview if value is a URL/path
                if (value && (value.startsWith('http') || value.startsWith('img/'))) {
                    const thumb = document.createElement('img');
                    thumb.src = value;
                    thumb.className = 'h-8 w-8 object-cover rounded border border-gray-200 ml-auto';
                    thumb.onerror = () => thumb.style.display = 'none'; // Hide if broken
                    uploadContainer.appendChild(thumb);
                }

                wrapper.appendChild(uploadContainer);
            }

            container.appendChild(wrapper);
        }

        function createArrayEditor(container, data, path) {
             const wrapper = document.createElement('div');
             wrapper.className = 'space-y-4 mb-6';
             
             data.forEach((item, index) => {
                 const itemCard = document.createElement('div');
                 itemCard.className = 'bg-gray-50 p-6 rounded-lg border border-gray-200 relative group transition hover:shadow-md';
                 
                 // Header Row
                 const header = document.createElement('div');
                 header.className = 'flex justify-between items-center mb-4';
                 
                 const indexBadge = document.createElement('span');
                 indexBadge.className = 'text-xs font-mono text-gray-500 bg-white px-2 py-1 rounded border border-gray-200';
                 indexBadge.textContent = `Item #${index + 1}`;
                 
                 const deleteBtn = document.createElement('button');
                 deleteBtn.className = 'text-red-400 hover:text-red-600 transition p-1 rounded hover:bg-red-50';
                 deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                 deleteBtn.title = "Delete Item";
                 deleteBtn.onclick = () => {
                     if(confirm("Are you sure you want to delete this item?")) {
                         // Helper to get parent array from state
                         let parent = currentContent;
                         for(let i=0; i<path.length; i++) parent = parent[path[i]];
                         
                         parent.splice(index, 1);
                         
                         renderEditor(currentContent);
                         updatePreview();
                     }
                 };
                 
                 header.appendChild(indexBadge);
                 header.appendChild(deleteBtn);
                 itemCard.appendChild(header);

                 // Check if item is primitive or object
                 if (typeof item === 'object' && item !== null) {
                    createFields(itemCard, item, [...path, index]);
                 } else {
                    // Primitive (String/Number) - e.g., Gallery Images or Service Locations
                    const isImage = path.includes('images') || (typeof item === 'string' && (item.includes('/') || item.includes('.')));
                    createInput(itemCard, item, [...path, index], isImage);
                 }

                 wrapper.appendChild(itemCard);
             });
             
             // Add New Item Button
             const addBtn = document.createElement('button');
             addBtn.className = 'w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 rounded-lg hover:border-brand hover:text-brand hover:bg-blue-50 transition font-medium text-sm flex items-center justify-center gap-2';
             addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add New Item';
             addBtn.onclick = () => {
                 let newItem;
                 
                 // 1. Try to clone last item if exists
                 if (data.length > 0) {
                     const last = data[0]; // Clone schema from first item
                     if (typeof last === 'object' && last !== null) {
                         newItem = JSON.parse(JSON.stringify(last));
                         // Clear values
                         Object.keys(newItem).forEach(k => {
                             if (k === 'id') newItem[k] = 'post-' + Date.now();
                             else if (typeof newItem[k] === 'string') newItem[k] = '';
                             else if (typeof newItem[k] === 'boolean') newItem[k] = false;
                         });
                     } else {
                         // Primitive clone (empty string)
                         newItem = "";
                     }
                 } else {
                     // 2. Fallback for empty array. 
                     if (path.includes('posts')) {
                         newItem = {
                             id: 'post-' + Date.now(),
                             title: 'New Post',
                             date: new Date().toLocaleDateString(),
                             coverImage: '',
                             excerpt: '',
                             content: ''
                         };
                     } else if (path.includes('badges')) { // Trust badges
                         newItem = { img: '', title: '', winnerLabel: '' };
                     } else if (path.includes('list')) { // Brands
                         newItem = { name: '', logo: '' };
                     } else if (path.includes('items')) { // Services/Reviews
                         newItem = { title: '', iconClass: '', description: '', text: '', author: '', date: '' };
                     } else if (path.includes('images') || path.includes('locations')) {
                         newItem = ""; // Default string for gallery/locations
                     } else {
                         newItem = ""; // Generic fallback
                     }
                 }
                 
                 // Add to parent
                 let parent = currentContent;
                 for(let i=0; i<path.length; i++) parent = parent[path[i]];
                 parent.push(newItem);
                 
                 renderEditor(currentContent);
                 updatePreview();
             };
             
             wrapper.appendChild(addBtn);
             container.appendChild(wrapper);
        }

        function updateContentInState(path, newValue) {
            let obj = currentContent;
            for (let i = 0; i < path.length - 1; i++) {
                obj = obj[path[i]];
            }
            obj[path[path.length - 1]] = newValue;
            
            // Sync with preview
            // Debounce could be added here for performance
            updatePreview();
        }

        function showHelp(key) {
            const info = SECTION_INFO[key];
            if (!info) return;
            
            const modal = document.getElementById('help-modal');
            const content = document.getElementById('help-content');
            
            content.innerHTML = `
                <div class="mb-6">
                    <p class="text-gray-600 leading-relaxed">${info.desc}</p>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Visual Preview</h4>
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 flex items-center justify-center overflow-hidden">
                        <div class="transform scale-100 origin-center w-full max-w-md">
                            ${info.html}
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-center"><i class="fa-solid fa-info-circle"></i> Simplified representation</p>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
    </script>
</body>
</html>
