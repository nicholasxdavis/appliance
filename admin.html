<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AJ's Repair - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Outfit', sans-serif; }
        .json-editor-input { @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500; }
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 z-20 flex-shrink-0">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-14">
                <div class="flex items-center gap-4">
                    <span class="text-xl font-bold text-gray-800">Admin Panel</span>
                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full hidden" id="connection-status">Connected</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="saveContent()" id="save-btn" class="hidden bg-green-600 text-white px-4 py-1.5 text-sm rounded-md hover:bg-green-700 transition flex items-center gap-2">
                        <i class="fa-solid fa-save"></i> Save Changes
                    </button>
                    <button onclick="logout()" class="text-gray-500 hover:text-red-500 text-sm">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Editor Sidebar (Left) -->
        <div id="editor-pane" class="w-1/3 bg-white border-r border-gray-200 flex flex-col overflow-hidden hidden relative">
             <div class="border-b border-gray-200 bg-gray-50 overflow-x-auto flex-shrink-0">
                <div id="section-tabs" class="flex"></div>
            </div>
            <div id="editor-container" class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Fields injected here -->
            </div>
        </div>

        <!-- Preview Pane (Right) -->
        <div id="preview-pane" class="w-2/3 bg-gray-100 relative hidden flex-col">
            <div class="bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center text-xs text-gray-500">
                <span><i class="fa-solid fa-eye"></i> Live Preview</span>
                <span>index.html</span>
            </div>
            <iframe id="preview-frame" src="index.html" class="w-full h-full border-none bg-white"></iframe>
        </div>

        <!-- Auth Overlay (GitHub) -->
        <div id="auth-section" class="absolute inset-0 bg-gray-100 z-40 flex items-center justify-center hidden">
            <!-- (Content remains same but initially hidden) -->
             <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full relative">
                <button onclick="logoutApp()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-arrow-left"></i> Back
                </button>
                <h2 class="text-2xl font-bold mb-2 text-center text-gray-800">GitHub Connection</h2>
                <!-- ... form ... -->
                <form onsubmit="event.preventDefault(); login();" class="space-y-4 mt-6">
                    <!-- ... inputs ... -->
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Owner / Username</label>
                        <input type="text" id="repo-owner" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" value="nicholasxdavis" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Repository</label>
                        <input type="text" id="repo-name" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" value="appliance" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">
                            GitHub Token <span class="text-gray-400 font-normal">(Value of GITHUB0API0KEY)</span>
                        </label>
                        <input type="password" id="github-token" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Paste your GITHUB0API0KEY here" required>
                        <p class="text-xs text-gray-400 mt-1">
                            <i class="fa-solid fa-circle-info"></i> Browser cannot fetch Secrets automatically. Please paste the token value.
                        </p>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2.5 rounded-md hover:bg-blue-700 transition font-medium shadow-sm">Connect Dashboard</button>
                    <p id="login-error" class="hidden text-red-500 text-xs text-center mt-2"></p>
                </form>
            </div>
        </div>

        <!-- App Login Overlay (Gatekeeper) -->
        <div id="app-login-section" class="absolute inset-0 bg-gray-900 z-50 flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Admin Access</h1>
                    <p class="text-sm text-gray-500">Please authenticate to continue</p>
                </div>
                
                <form onsubmit="event.preventDefault(); appLogin();" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Email</label>
                        <input type="email" id="app-email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-1">Password</label>
                        <input type="password" id="app-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                    </div>
                    <button type="submit" class="w-full bg-gray-800 text-white py-2.5 rounded-md hover:bg-gray-900 transition font-medium shadow-sm">
                        Login
                    </button>
                    <p id="app-login-error" class="hidden text-center text-red-600 text-xs font-medium"></p>
                </form>
            </div>
        </div>

    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toast-msg">Notification</span>
    </div>

    <!-- Load Config (Injected Secrets) -->
    <script src="js/config.js"></script> <!-- Will fail silently if not present, which is fine -->

    <script>
        // State
        let currentContent = null;
        let fileSha = null;
        let activeTab = 'general';
        const previewFrame = document.getElementById('preview-frame');

        // Credentials Configuration
        const VALID_USERS = [];

        // Load credentials on start
        document.addEventListener('DOMContentLoaded', () => {
             // 1. Consume Injected Config
             if (window.CONFIG) {
                 if (window.CONFIG.auth) {
                     window.CONFIG.auth.forEach(u => {
                         if(u.email && u.pass) VALID_USERS.push(u);
                     });
                 }
                 
                 // Auto-fill GitHub Token if available
                 if (window.CONFIG.github && window.CONFIG.github.token && !localStorage.getItem('gh_token')) {
                     document.getElementById('github-token').value = window.CONFIG.github.token;
                 }
             } else {
                 // Config missing detector
                 console.warn('js/config.js not loaded. Secrets will not be available.');
                 const authSection = document.getElementById('auth-section');
                 if(authSection) {
                     const warning = document.createElement('div');
                     warning.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 text-sm';
                     warning.innerHTML = `
                        <p class="font-bold">⚠️ Secrets Configuration Missing</p>
                        <p>The file <code>js/config.js</code> returned 404.</p>
                        <p class="mt-2"><strong>Fix:</strong> Go to Repo Settings > Pages > Build and deployment.</p>
                        <p>Change <strong>Source</strong> to "GitHub Actions".</p>
                     `;
                     // Insert at top of auth/login forms
                     const appLogin = document.getElementById('app-login-section');
                     if(appLogin && !appLogin.classList.contains('hidden')) {
                         appLogin.querySelector('form').before(warning.cloneNode(true));
                     }
                     authSection.querySelector('form').before(warning);
                 }
             }

             // Add hardcoded fallback for manual testing/demo if config is empty
             if (VALID_USERS.length === 0) {
                 VALID_USERS.push({ email: 'nic@example.com', pass: 'passwordexample' });
                 VALID_USERS.push({ email: 'admin@example.com', pass: 'password' });
                 // Fallback only; if user runs inject_config.js with valid envs, they get priority.
             }

             // Check App Auth
             if (sessionStorage.getItem('app_authenticated') === 'true') {
                 showGitHubAuth();
             }
        });

        function appLogin() {
            const email = document.getElementById('app-email').value;
            const pass = document.getElementById('app-password').value;
            const errorMsg = document.getElementById('app-login-error');

            const isValid = VALID_USERS.some(u => u.email === email && u.pass === pass);

            if (isValid) {
                sessionStorage.setItem('app_authenticated', 'true');
                showGitHubAuth();
            } else {
                errorMsg.textContent = 'Invalid Credentials. Access Denied.';
                errorMsg.classList.remove('hidden');
            }
        }

        function logoutApp() {
            sessionStorage.removeItem('app_authenticated');
            location.reload();
        }

        function showGitHubAuth() {
            document.getElementById('app-login-section').classList.add('hidden');
            
            // 1. Try LocalStorage (Existing session) or Injected Config (Auto-login)
            const token = localStorage.getItem('gh_token') || (window.CONFIG && window.CONFIG.github && window.CONFIG.github.token);
            
            // Allow override of owner/repo if injected via config (not currently set but future proof)
            const owner = localStorage.getItem('gh_owner') || 'nicholasxdavis';
            const repo = localStorage.getItem('gh_repo') || 'appliance';

            if (token) {
                // Pre-fill inputs just in case, but hide section ideally
                document.getElementById('github-token').value = token;
                document.getElementById('repo-owner').value = owner;
                document.getElementById('repo-name').value = repo; 
                
                attemptLogin(token, owner, repo);
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
            }
        }

        function login() {
            const token = document.getElementById('github-token').value;
            const owner = document.getElementById('repo-owner').value;
            const repo = document.getElementById('repo-name').value;
            attemptLogin(token, owner, repo);
        }

        async function attemptLogin(token, owner, repo) {
            const btn = document.querySelector('button[type="submit"]');
            if(btn) { btn.disabled = true; btn.textContent = 'Connecting...'; }

            try {
                // Test connection by fetching user
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (!userRes.ok) throw new Error('Invalid Token');

                localStorage.setItem('gh_token', token);
                localStorage.setItem('gh_owner', owner);
                localStorage.setItem('gh_repo', repo);

                await loadContent();
                
                // Show UI
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('editor-pane').classList.remove('hidden');
                document.getElementById('preview-pane').classList.remove('hidden');
                document.getElementById('preview-pane').classList.add('flex');
                document.getElementById('save-btn').classList.remove('hidden');
                document.getElementById('connection-status').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                document.getElementById('login-error').textContent = error.message;
                document.getElementById('login-error').classList.remove('hidden');
                logout(); // Clear bad creds
            } finally {
                if(btn) { btn.disabled = false; btn.textContent = 'Connect Dashboard'; }
            }
        }

        function logout() {
            localStorage.removeItem('gh_token');
            location.reload();
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${isError ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        async function loadContent() {
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const path = 'content.json';

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                });

                if (!response.ok) throw new Error('Could not fetch content.json');

                const data = await response.json();
                fileSha = data.sha;
                
                // Decode UTF-8 properly
                const decodedContent = decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, ""))));
                currentContent = JSON.parse(decodedContent);

                renderTabs();
                renderEditor(activeTab);
                updatePreview(); // Initial sync

            } catch (error) {
                console.error(error);
                showToast(error.message, true);
            }
        }

        // Debounce timer
        let previewTimeout;

        function updatePreview() {
            if (!currentContent) return;
            
            // Clear existing timeout
            if (previewTimeout) clearTimeout(previewTimeout);

            // Debounce for 50ms to strictly follow 'live' feel without choking
            previewTimeout = setTimeout(() => {
                console.log('Sending preview update...', new Date().toISOString());
                const previewFrame = document.getElementById('preview-frame');
                if (previewFrame && previewFrame.contentWindow) {
                    previewFrame.contentWindow.postMessage({
                        type: 'previewUpdate',
                        content: currentContent
                    }, '*');
                }
            }, 50);
        }

        // Add listener to iframe load to ensure we sync on initial load
        const previewFrameEl = document.getElementById('preview-frame');
        if (previewFrameEl) {
             // Cache buster
             previewFrameEl.src = `index.html?t=${Date.now()}`;
             
             previewFrameEl.onload = () => {
                 setTimeout(updatePreview, 500);
             };
        }

        async function saveContent() {
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const path = 'content.json';
            
            const btn = document.getElementById('save-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="loader"></i> Saving...';
            btn.disabled = true;

            try {
                const contentStr = JSON.stringify(currentContent, null, 2);
                const encodedContent = window.btoa(unescape(encodeURIComponent(contentStr)));

                const body = {
                    message: "Update content via Admin Panel",
                    content: encodedContent,
                    sha: fileSha
                };

                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error('Failed to save to GitHub');

                const data = await response.json();
                fileSha = data.content.sha;
                showToast('Changes saved successfully!');
            } catch (error) {
                console.error(error);
                showToast('Error saving: ' + error.message, true);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // Image Upload Logic
        async function uploadImage(file, fieldPath) {
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            
            if (!file) return;

            showToast('Uploading image...');

            try {
                // Read file as Base64
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const contentBase64 = e.target.result.split(',')[1];
                    const filename = `img/${Date.now()}_${file.name.replace(/\s+/g, '-')}`; // Unique name
                    
                    // Upload to GitHub
                    const body = {
                        message: `Upload image ${file.name}`,
                        content: contentBase64
                    };

                    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filename}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) throw new Error('Image upload failed');
                    
                    const data = await response.json();
                    
                    // Get 'download_url' or construct relative path if using Pages
                    // Using relative path is safer for this specific setup
                    const imagePath = filename; 
                    
                    // Update Content
                    updateContentInState(fieldPath, imagePath);
                    
                    // Force refresh editor input
                    renderEditor(activeTab); // Brute force refresh to show new value
                    showToast('Image uploaded and linked!');
                };
                reader.readAsDataURL(file);

            } catch (error) {
                console.error(error);
                showToast('Upload error: ' + error.message, true);
            }
        }


        // UI Rendering Logic ----------------------

        function renderTabs() {
            const container = document.getElementById('section-tabs');
            container.innerHTML = '';
            
            Object.keys(currentContent).forEach(key => {
                const btn = document.createElement('button');
                btn.textContent = key;
                btn.className = `px-5 py-3 text-sm font-medium capitalize border-b-2 transition whitespace-nowrap ${activeTab === key ? 'border-blue-600 text-blue-600 bg-white' : 'border-transparent text-gray-500 hover:text-gray-700'}`;
                btn.onclick = () => {
                    activeTab = key;
                    renderTabs();
                    renderEditor(key);
                };
                container.appendChild(btn);
            });
        }

        function renderEditor(sectionKey) {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            // Pass the path to update function
            createFields(container, currentContent[sectionKey], [sectionKey]);
        }

        function createFields(container, data, path) {
            if (typeof data !== 'object' || data === null) {
                // Check if it's an image field (heuristic: key contains 'img' or 'image' or 'logo')
                const key = path[path.length - 1].toLowerCase();
                const isImage = key.includes('img') || key.includes('image') || key.includes('logo') || key.includes('icon');
                
                createInput(container, data, path, isImage);
                return;
            }

            if (Array.isArray(data)) {
                createArrayEditor(container, data, path);
                return;
            }

            Object.keys(data).forEach(key => {
                const val = data[key];
                if (typeof val !== 'object') {
                    const isImage = key.toLowerCase().includes('img') || key.toLowerCase().includes('image') || key.toLowerCase().includes('logo') || key.toLowerCase().includes('icon');
                    createInput(container, val, [...path, key], isImage);
                } else {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'mb-6 border-l-2 border-gray-100 pl-4 py-1';
                    const title = document.createElement('h3');
                    title.className = 'text-xs font-bold text-gray-400 uppercase tracking-wider mb-3';
                    title.textContent = key;
                    wrapper.appendChild(title);
                    createFields(wrapper, val, [...path, key]);
                    container.appendChild(wrapper);
                }
            });
        }

        function createInput(container, value, path, isImage = false) {
            const wrapper = document.createElement('div');
            wrapper.className = 'mb-4 group';

            const labelRow = document.createElement('div');
            labelRow.className = 'flex justify-between items-center mb-1';
            
            const fieldLabel = document.createElement('label');
            fieldLabel.className = 'text-sm font-medium text-gray-700 capitalize';
            fieldLabel.textContent = path[path.length - 1];
            labelRow.appendChild(fieldLabel);

            wrapper.appendChild(labelRow);

            if (typeof value === 'boolean') {
                input = document.createElement('input');
                input.type = 'checkbox';
                input.checked = value;
                input.className = 'w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300 transition cursor-pointer';
                input.onchange = (e) => {
                    updateContentInState(path, e.target.checked);
                };
                
                // Special styling for boolean wrapper
                wrapper.className = 'mb-4 flex items-center gap-3 bg-gray-50 p-3 rounded-md border border-gray-200';
                labelRow.className = 'flex-1 mb-0';
                wrapper.innerHTML = ''; // Reset wrapper
                
                wrapper.appendChild(input);
                
                const label = document.createElement('label');
                label.className = 'text-sm font-medium text-gray-700 capitalize cursor-pointer select-none';
                label.textContent = path[path.length - 1];
                label.onclick = () => { input.click(); }; // Make label clickable
                wrapper.appendChild(label);
                
                container.appendChild(wrapper);
                return; // Early return for boolean
            }

            let input;
            if (typeof value === 'string' && value.length > 60 && !isImage) {
                input = document.createElement('textarea');
                input.rows = 3;
            } else {
                input = document.createElement('input');
                input.type = 'text';
            }
            
            input.className = 'w-full px-3 py-2 bg-white border border-gray-200 rounded text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition shadow-sm font-light text-gray-800';
            input.value = value;
            
            input.oninput = (e) => {
                updateContentInState(path, e.target.value);
            };

            wrapper.appendChild(input);

            // Image Upload Control
            if (isImage) {
                const uploadContainer = document.createElement('div');
                uploadContainer.className = 'mt-2 flex items-center gap-2';
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.className = 'hidden';
                fileInput.id = `file-${path.join('-')}`;
                
                fileInput.onchange = (e) => {
                    if (e.target.files.length > 0) {
                        uploadImage(e.target.files[0], path);
                    }
                };

                const uploadBtn = document.createElement('label');
                uploadBtn.htmlFor = fileInput.id;
                uploadBtn.className = 'cursor-pointer inline-flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded hover:bg-gray-200 transition';
                uploadBtn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> Upload New Image';
                
                uploadContainer.appendChild(fileInput);
                uploadContainer.appendChild(uploadBtn);
                
                // Thumbnail preview if value is a URL/path
                if (value && (value.startsWith('http') || value.startsWith('img/'))) {
                    const thumb = document.createElement('img');
                    thumb.src = value;
                    thumb.className = 'h-8 w-8 object-cover rounded border border-gray-200 ml-auto';
                    thumb.onerror = () => thumb.style.display = 'none'; // Hide if broken
                    uploadContainer.appendChild(thumb);
                }

                wrapper.appendChild(uploadContainer);
            }

            container.appendChild(wrapper);
        }

        function createArrayEditor(container, data, path) {
             const wrapper = document.createElement('div');
             wrapper.className = 'space-y-4 mb-6';
             
             data.forEach((item, index) => {
                 const itemCard = document.createElement('div');
                 itemCard.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 relative group';
                 
                 const indexBadge = document.createElement('span');
                 indexBadge.className = 'absolute top-2 right-2 text-xs font-mono text-gray-400 bg-white px-1.5 rounded border border-gray-100';
                 indexBadge.textContent = `#${index + 1}`;
                 itemCard.appendChild(indexBadge);

                 createFields(itemCard, item, [...path, index]);
                 wrapper.appendChild(itemCard);
             });
             container.appendChild(wrapper);
        }

        function updateContentInState(path, newValue) {
            let obj = currentContent;
            for (let i = 0; i < path.length - 1; i++) {
                obj = obj[path[i]];
            }
            obj[path[path.length - 1]] = newValue;
            
            // Sync with preview
            // Debounce could be added here for performance
            updatePreview();
        }

    </script>
</body>
</html>
